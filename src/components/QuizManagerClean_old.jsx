import React, { useState, useEffect, useContext, useCallback, useMemo } from 'react';
import { createPortal } from 'react-dom';
import { doc, updateDoc } from 'firebase/firestore';
import { httpsCallable } from "firebase/functions";
import { FirebaseContext } from '../contexts/FirebaseContext.jsx';
import { gameplayConfig } from '../utils/data';
import { badgeService } from '../services/badgeService';
import QuizModal from './QuizModalSimple';

const QuizManager = () => {

    // Flag local pour bloquer toute r√©activation pendant le nettoyage
    const isCleaningUpRef = React.useRef(false);

    // √âtat persistant dans localStorage pour √©viter la perte lors des re-rendus
    const [showQuiz, setShowQuiz] = useState(() => {
        try {
            return localStorage.getItem('drinkwise_quiz_active') === 'true';
        } catch {
            return false;
        }
    });

    const [partyData, setPartyData] = useState(() => {
        try {
            const data = localStorage.getItem('drinkwise_quiz_data');
            return data ? JSON.parse(data) : null;
        } catch {
            return null;
        }
    });

    const [partyId, setPartyId] = useState(() => {
        try {
            return localStorage.getItem('drinkwise_quiz_id') || null;
        } catch {
            return null;
        }
    });

    // Effet de s√©curit√© : force la fermeture du quiz si le nettoyage est en cours
    useEffect(() => {
        if (isCleaningUpRef.current && showQuiz) {
            console.warn("üõ°Ô∏è QuizManager - Nettoyage en cours, fermeture forc√©e du quiz (effet de s√©curit√©)");
            setShowQuiz(false);
            setPartyData(null);
            setPartyId(null);
            setFromPartyMode(false);
        }
    }, [showQuiz]);

    const { db, user, appId, setMessageBox, functions, userProfile, completeQuiz } = useContext(FirebaseContext);

    console.log("üéØ QuizManager - MONT√â/RE-MONT√â");  // Logs r√©duits

    useEffect(() => {
        console.log("üéØ QuizManager - Initialisation du syst√®me de d√©tection de quiz OPTIMIS√â");
        
        // Fonction pour d√©tecter si un quiz doit √™tre affich√©
        const detectQuizToShow = () => {
            // Bloquer toute d√©tection si nettoyage en cours
            if (isCleaningUpRef.current) {
                console.warn("‚è≥ QuizManager - Nettoyage en cours, d√©tection quiz bloqu√©e");
                return false;
            }
            try {
                const quizActive = localStorage.getItem('drinkwise_quiz_active') === 'true';
                const quizData = localStorage.getItem('drinkwise_quiz_data');
                const quizId = localStorage.getItem('drinkwise_quiz_id');
                const quizFromParty = localStorage.getItem('drinkwise_quiz_from_party') === 'true';
                const quizTrigger = localStorage.getItem('drinkwise_quiz_trigger');

                // Log r√©duit - seulement si d√©tection importante
                if (quizActive && quizData && quizId) {
                    console.log("üîç QuizManager - Quiz disponible dans localStorage:", { 
                        quizActive, 
                        hasQuizData: !!quizData, 
                        hasQuizId: !!quizId, 
                        quizFromParty, 
                        currentShowQuiz: showQuiz 
                    });
                }

                // Si le quiz est actif et qu'on a des donn√©es, mais que showQuiz est false, l'activer
                if (quizActive && quizData && quizId && !showQuiz) {
                    console.log("üîç Quiz d√©tect√© dans localStorage, activation...");

                    const parsedData = JSON.parse(quizData);
                    setPartyData(parsedData);
                    setPartyId(quizId);
                    setFromPartyMode(quizFromParty);
                    setShowQuiz(true);

                    console.log("‚úÖ Quiz activ√© avec les donn√©es:", { parsedData, quizId, quizFromParty });

                    return true;
                }

                return false;
            } catch (error) {
                console.error("‚ùå Erreur d√©tection quiz:", error);
                return false;
            }
        };
        
        // V√©rifier imm√©diatement SEULEMENT si pas d√©j√† ouvert
        if (!showQuiz) {
            console.log("üéØ QuizManager - V√©rification imm√©diate (quiz ferm√©)...");
            detectQuizToShow();
        } else {
            console.log("üéØ QuizManager - Quiz d√©j√† ouvert, pas de v√©rification");
        }
        
        // Polling MOINS fr√©quent et intelligent
        const pollInterval = setInterval(() => {
            // Seulement si le quiz n'est pas d√©j√† ouvert
            if (!showQuiz) {
                const quizActive = localStorage.getItem('drinkwise_quiz_active') === 'true';
                const quizData = localStorage.getItem('drinkwise_quiz_data');
                const quizId = localStorage.getItem('drinkwise_quiz_id');
                
                if (quizActive && quizData && quizId) {
                    console.log("üîç Quiz d√©tect√© via polling, activation...");
                    detectQuizToShow();
                }
            }
        }, 1000); // Polling encore moins fr√©quent pour √©viter la boucle
        
        // Event listener pour les √©v√©nements storage - PLUS intelligent
        const handleStorageChange = (event) => {
            // Seulement si le quiz n'est pas d√©j√† ouvert ET si c'est un √©v√©nement quiz
            if (!showQuiz && event.key && event.key.includes('drinkwise_quiz')) {
                console.log("üì¶ QuizManager - Changement localStorage quiz d√©tect√©");
                detectQuizToShow();
            }
        };
        
        // Event listener pour l'√©v√©nement personnalis√© quizTrigger - PLUS intelligent
        const handleQuizTrigger = (event) => {
            // Seulement si le quiz n'est pas d√©j√† ouvert
            if (!showQuiz) {
                console.log("üéØ QuizManager - √âv√©nement quizTrigger re√ßu:", event.detail);
                detectQuizToShow();
            } else {
                console.log("üéØ QuizManager - QuizTrigger ignor√© (quiz d√©j√† ouvert)");
            }
        };
        
        window.addEventListener('storage', handleStorageChange);
        window.addEventListener('quizTrigger', handleQuizTrigger);
        
        console.log("‚úÖ QuizManager - Syst√®me de d√©tection OPTIMIS√â activ√©:", {
            polling: "1000ms",
            storageListener: true,
            quizTriggerListener: true,
            currentShowQuiz: showQuiz
        });
        
        return () => {
            clearInterval(pollInterval);
            window.removeEventListener('storage', handleStorageChange);
            window.removeEventListener('quizTrigger', handleQuizTrigger);
            console.log("üö´ QuizManager - D√âMONTAGE - Syst√®me de d√©tection d√©sactiv√©");
        };
    }, [showQuiz]);  // Garder showQuiz pour la logique conditionnelle mais √©viter les boucles

    // Effet pour surveiller la fermeture du quiz et forcer le nettoyage
    useEffect(() => {
        if (!showQuiz && (partyData || partyId)) {
            console.log("üßπ QuizManager - D√©tection d'√©tat incoh√©rent, nettoyage forc√©");
            setPartyData(null);
            setPartyId(null);
            setFromPartyMode(false);
            try {
                localStorage.removeItem('drinkwise_quiz_data');
                localStorage.removeItem('drinkwise_quiz_id');
                localStorage.removeItem('drinkwise_quiz_active');
                localStorage.removeItem('drinkwise_quiz_from_party');
                localStorage.removeItem('drinkwise_quiz_trigger');
                localStorage.removeItem('drinkwise_quiz_party_state_before');
                localStorage.removeItem('currentQuiz');
            } catch (error) {
                console.error("‚ùå Erreur nettoyage forc√©:", error);
            }
        }
    }, [showQuiz, partyData, partyId]);

    const handleQuizComplete = useCallback(async (result) => {
        console.log("üéØ QuizManager - Quiz termin√©, calcul des r√©compenses...");
        
        // Calculer l'XP de base
        const xpGained = gameplayConfig.xpPerParty;
        let newBadges = [];
        try {
            // Essayer de g√©n√©rer le r√©sum√© avec IA (fonction Cloud avec CORS corrig√©)
            try {
                const generateSummary = httpsCallable(functions, 'generateSummary');
                const summaryResult = await generateSummary({
                    partyData: partyData,
                    drunkLevel: result,
                    appId: appId
                });
                if (summaryResult.data?.success) {
                    const userDocRef = doc(db, 'users', user.uid);
                    await updateDoc(userDocRef, {
                        [`parties.${partyId}.summary`]: summaryResult.data.summary
                    });
                    console.log("‚úÖ R√©sum√© g√©n√©r√© avec IA:", summaryResult.data.summary.substring(0, 50) + "...");
                } else {
                    console.log("‚ö†Ô∏è √âchec g√©n√©ration r√©sum√©:", summaryResult.data?.error);
                }
            } catch (summaryError) {
                console.log("‚ö†Ô∏è Erreur r√©sum√© ignor√©e:", summaryError.message);
            }
            // Essayer de v√©rifier les badges (optionnel)
            try {
                console.log("üéñÔ∏è V√©rification des badges...");
                const badgeResult = await badgeService.checkAndAwardBadges(db, user, userProfile, appId, partyData);
                newBadges = badgeResult?.newBadges || [];
                console.log("‚úÖ Badges v√©rifi√©s");
            } catch (badgeError) {
                console.log("‚ö†Ô∏è Erreur badges ignor√©e:", badgeError.message);
            }
            // Mettre √† jour le profil utilisateur avec l'XP (critique)
            try {
                const userDocRef = doc(db, 'users', user.uid);
                const updateData = {
                    [`appProfiles.${appId}.xp`]: (userProfile.xp || 0) + xpGained,
                    [`appProfiles.${appId}.lastActivity`]: new Date().toISOString()
                };
                await updateDoc(userDocRef, updateData);
                console.log("‚úÖ Profil mis √† jour avec +", xpGained, "XP");
            } catch (xpError) {
                console.log("‚ö†Ô∏è Erreur XP ignor√©e:", xpError.message);
                // En cas d'erreur, on garde quand m√™me l'XP localement pour l'affichage
            }
        } catch (error) {
            console.error("‚ùå Erreur g√©n√©rale:", error);
        }
        
        // Nettoyer localStorage IMM√âDIATEMENT
        try {
            localStorage.removeItem('drinkwise_quiz_data');
            localStorage.removeItem('drinkwise_quiz_id');
            localStorage.removeItem('drinkwise_quiz_active');
            localStorage.removeItem('drinkwise_quiz_from_party');
            localStorage.removeItem('drinkwise_quiz_trigger');
            localStorage.removeItem('drinkwise_quiz_party_state_before');
            localStorage.removeItem('currentQuiz');
            console.log("üßπ localStorage nettoy√©");
        } catch (error) {
            console.error("‚ùå Erreur nettoyage localStorage:", error);
        }
        
        // Fermer l'√©tat React IMM√âDIATEMENT
        setShowQuiz(false);
        setPartyData(null);
        setPartyId(null);
        setFromPartyMode(false);
        console.log("üîí √âtats React ferm√©s");

        // Boucle de s√©curit√© pour forcer le nettoyage tant que le quiz reste actif

        // IMPORTANT : TOUS les quiz ferment le mode soir√©e, peu importe leur origine
        const partyStateBefore = localStorage.getItem('drinkwise_quiz_party_state_before');
        let partyStateBeforeData = null;
        try {
            partyStateBeforeData = partyStateBefore ? JSON.parse(partyStateBefore) : null;
        } catch (e) {
            console.warn("‚ö†Ô∏è Erreur parsing √©tat avant quiz:", e);
        }
        
        console.log("üéØ Fermeture automatique du mode soir√©e apr√®s tout quiz");
        console.log("üìä Origine quiz:", fromPartyMode ? "mode soir√©e" : "formulaire normal");
        console.log("üìä √âtat avant quiz:", partyStateBeforeData);
        
        if (typeof completeQuiz === 'function') {
            // Appeler TOUJOURS la fonction, m√™me si le mode soir√©e semble ferm√©
            // (au cas o√π il y aurait un d√©salignement d'√©tat)
            completeQuiz();
            console.log("‚úÖ Mode soir√©e ferm√© automatiquement via completeQuiz (origine:", fromPartyMode ? "mode soir√©e" : "formulaire normal", ")");
            
            // Attendre que React mette √† jour l'√©tat avant de d√©clencher l'√©v√©nement
            setTimeout(() => {
                const partyCompletedEvent = new CustomEvent('partyCompleted', {
                    detail: { partyData, partyId }
                });
                window.dispatchEvent(partyCompletedEvent);
                console.log("üì§ √âv√©nement partyCompleted envoy√© depuis quiz termin√© (origine:", fromPartyMode ? "mode soir√©e" : "formulaire normal", ")");
            }, 100); // D√©lai r√©duit mais suffisant pour React
        } else {
            console.error("‚ùå completeQuiz n'est pas disponible");
        }

        // D√©clencher un √©v√©nement global pour la notification
        const notificationEvent = new CustomEvent('showRewardNotification', {
            detail: { xpGained, newBadges }
        });
        window.dispatchEvent(notificationEvent);
        console.log("‚úÖ √âv√©nement notification envoy√©:", { xpGained, newBadges });
    }, [partyData, partyId, db, user, userProfile, appId, functions, completeQuiz]);

    const handleQuizClose = useCallback(() => {
        console.log("üéØ QuizManager - Fermeture du quiz demand√©e");
        
        // Nettoyer localStorage IMM√âDIATEMENT
        try {
            localStorage.removeItem('drinkwise_quiz_data');
            localStorage.removeItem('drinkwise_quiz_id');
            localStorage.removeItem('drinkwise_quiz_active');
            localStorage.removeItem('drinkwise_quiz_from_party');
            localStorage.removeItem('drinkwise_quiz_trigger');
            localStorage.removeItem('drinkwise_quiz_party_state_before');
            localStorage.removeItem('currentQuiz');
            console.log("üßπ localStorage nettoy√© lors de la fermeture");
        } catch (error) {
            console.error("‚ùå Erreur nettoyage localStorage:", error);
        }
        
        // Fermer l'√©tat React IMM√âDIATEMENT
        setShowQuiz(false);
        setPartyData(null);
        setPartyId(null);
        setFromPartyMode(false);
        console.log("üîí √âtats React ferm√©s lors de la fermeture");
        
        // Forcer un re-render imm√©diat avec un timeout de s√©curit√©
        setTimeout(() => {
            console.log("üõ°Ô∏è V√©rification s√©curit√© - forcer fermeture manuelle si encore ouvert");
            setShowQuiz(false);
            setPartyData(null);
            setPartyId(null);
            setFromPartyMode(false);
        }, 100);
        
        // IMPORTANT : TOUS les quiz ferment le mode soir√©e, peu importe leur origine
        const partyStateBefore = localStorage.getItem('drinkwise_quiz_party_state_before');
        let partyStateBeforeData = null;
        try {
            partyStateBeforeData = partyStateBefore ? JSON.parse(partyStateBefore) : null;
        } catch (e) {
            console.warn("‚ö†Ô∏è Erreur parsing √©tat avant quiz:", e);
        }
        
        console.log("üéØ Fermeture manuelle du mode soir√©e apr√®s fermeture quiz");
        console.log("üìä Origine quiz:", fromPartyMode ? "mode soir√©e" : "formulaire normal");
        console.log("üìä √âtat avant quiz:", partyStateBeforeData);
        
        if (typeof completeQuiz === 'function') {
            completeQuiz();
            console.log("‚úÖ Mode soir√©e ferm√© manuellement via completeQuiz (origine:", fromPartyMode ? "mode soir√©e" : "formulaire normal", ")");
            // Attendre que React mette √† jour l'√©tat avant de d√©clencher l'√©v√©nement
            setTimeout(() => {
                const event = new CustomEvent('partyCompleted', {
                    detail: { partyData, partyId }
                });
                window.dispatchEvent(event);
                console.log("üì§ Quiz ferm√© manuellement (origine:", fromPartyMode ? "mode soir√©e" : "formulaire normal", ")");
            }, 200); // D√©lai augment√© pour garantir la synchro React
        } else {
            console.error("‚ùå completeQuiz n'est pas disponible lors de la fermeture manuelle");
        }
    }, [partyData, partyId, fromPartyMode, completeQuiz]);

    // M√©moriser le quiz pour √©viter les re-renders inutiles
    const quizModal = useMemo(() => {
        // V√©rification TR√àS stricte : si showQuiz est false, JAMAIS afficher le quiz
        if (!showQuiz) {
            return null;
        }
        
        if (!partyData) {
            console.log("üö´ QuizManager - Pas de donn√©es de soir√©e");
            // Si showQuiz est true mais pas de donn√©es, forcer la fermeture
            setShowQuiz(false);
            return null;
        }

        console.log("‚úÖ QuizManager - Rendu du QuizModal");
        return (
            <QuizModal 
                onQuizComplete={handleQuizComplete}
                onClose={handleQuizClose}
            />
        );
    }, [showQuiz, partyData, handleQuizComplete, handleQuizClose]);

    // Debug - logs tr√®s r√©duits, seulement pour les changements importants
    const shouldLog = showQuiz; // Log seulement quand le quiz est ouvert
    
    if (shouldLog) {
        let localStorageQuizActive;
        try {
            localStorageQuizActive = localStorage.getItem('drinkwise_quiz_active');
        } catch {
            localStorageQuizActive = null;
        }
        
        console.log("üéØ QuizManager - √âtats (quiz ouvert):", { 
            showQuiz, 
            hasPartyData: !!partyData, 
            localStorageActive: localStorageQuizActive 
        });
    }

    // V√âRIFICATION FINALE : Si showQuiz est false, retourner ABSOLUMENT null
    if (!showQuiz) {
        return null;
    }

    return quizModal ? createPortal(quizModal, document.body) : null;
};

export default QuizManager;
